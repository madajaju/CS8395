1
00:00:00,000 --> 00:00:04,133
In this lecture, we're gonna
talk about cookies sessions and cross-site

2
00:00:04,133 --> 00:00:09,400
request forgeries, or CSR
and how to avoid them.

3
00:00:09,400 --> 00:00:12,400
So that's, that's our goal of, of this.

4
00:00:12,566 --> 00:00:16,433
It's going to be an interesting
there's a lot to unpack again in this one.

5
00:00:16,966 --> 00:00:21,166
But by the end of this session, though,
this lecture, you should be able

6
00:00:21,166 --> 00:00:25,666
to explain how cookies work
at an architectural level, explain

7
00:00:25,666 --> 00:00:29,533
how server side sessions are represented
and states can be stored.

8
00:00:30,066 --> 00:00:33,400
Describe what is a CSR ref

9
00:00:33,700 --> 00:00:36,766
and how to prevent it from happening.

10
00:00:37,033 --> 00:00:42,633
And then identify any risks and trade offs
on using sessions and cookies

11
00:00:42,866 --> 00:00:46,266
and, 
compare any mitigation strategies for CSR.

12
00:00:48,500 --> 00:00:48,900
Okay.

13
00:00:48,900 --> 00:00:51,033
So first off why do we want cookies.

14
00:00:51,033 --> 00:00:54,033
Well Https is stateless.

15
00:00:54,066 --> 00:00:57,000
So if I'm a client let's say in a browser

16
00:00:57,000 --> 00:01:00,266
and I, access a service

17
00:01:01,033 --> 00:01:05,366
on the back end of something,
I, the server gets that one request

18
00:01:05,366 --> 00:01:06,900
and then if another request comes in,

19
00:01:06,900 --> 00:01:09,900
it doesn't know it can't remember
what the prior requests were.

20
00:01:10,133 --> 00:01:11,833
So if I log in as a user

21
00:01:12,933 --> 00:01:15,933
and I want to look at my account
information,

22
00:01:16,333 --> 00:01:19,766
I would have to pass
that account information in each time

23
00:01:20,033 --> 00:01:23,566
so that same user across
multiple requests is an important thing.

24
00:01:23,733 --> 00:01:26,700
I need to store that state somewhere,
right.

25
00:01:26,700 --> 00:01:30,500
And one of the ways that we do
that is through cookies and sessions.

26
00:01:30,500 --> 00:01:35,966
It's a way of persisting state,
from the browser and also in the server.

27
00:01:36,300 --> 00:01:39,300
So but because I'm storing that state,

28
00:01:39,700 --> 00:01:45,600
that opens up the door to these cross-site
request forgeries, right.

29
00:01:45,600 --> 00:01:48,966
They can abuse, cookies. Right.

30
00:01:48,966 --> 00:01:53,633
Because the idea is if the browser
has the my identity in there

31
00:01:54,433 --> 00:01:57,433
that I can send to the server
and I can send multiple requests

32
00:01:57,433 --> 00:02:00,966
to the server, couldn't
someone grab my identity from my cookies

33
00:02:02,200 --> 00:02:04,266
and, pretend like they're me?

34
00:02:04,266 --> 00:02:07,266
That's the whole idea behind, Csrf.

35
00:02:07,566 --> 00:02:10,200
Okay, so big picture.
This is how it works.

36
00:02:10,200 --> 00:02:14,533
A client submits a form,
it goes into the, through the browser.

37
00:02:14,633 --> 00:02:15,366
The browser.

38
00:02:15,366 --> 00:02:19,700
When it asks for a request to the web
server, it sends in the request.

39
00:02:19,700 --> 00:02:23,266
And cookies,
if there are any, in a response back,

40
00:02:23,466 --> 00:02:27,533
it's going to set cookies in the headers,
back into the browser.

41
00:02:27,533 --> 00:02:29,033
The browser is going to store that cookie.

42
00:02:29,033 --> 00:02:32,033
Oh, the user had this,

43
00:02:32,100 --> 00:02:35,100
log in or use this name.

44
00:02:35,200 --> 00:02:39,433
Whatever the case may be that's
set back in the cookies in the browser.

45
00:02:39,433 --> 00:02:42,500
So now when the user submits
something else,

46
00:02:42,666 --> 00:02:46,433
it has that information, goes, hey,
this is the person that's logged in.

47
00:02:46,433 --> 00:02:49,566
Pass that information from the browser
into the web server.

48
00:02:49,900 --> 00:02:54,433
So the browser stores the cookies
locally per domain and per path,

49
00:02:54,733 --> 00:02:59,600
and then sends them automatically
when the user asks for more.

50
00:03:00,666 --> 00:03:03,633
Information through the web browser.

51
00:03:03,633 --> 00:03:06,066
Okay, so what a cookie is, is,

52
00:03:06,066 --> 00:03:09,366
is just a small piece of data
that is stored in the browser per domain.

53
00:03:09,700 --> 00:03:12,566
They use cookies
for a lot of different things, right?

54
00:03:12,566 --> 00:03:16,366
It's automatically sent with
matching requests when they go through.

55
00:03:16,533 --> 00:03:20,200
Well, some applications, some websites.

56
00:03:20,666 --> 00:03:24,433
Scour your cookies and,

57
00:03:24,433 --> 00:03:29,466
they will, pass those cookies
into your Http request.

58
00:03:29,466 --> 00:03:30,666
That's going through.

59
00:03:30,666 --> 00:03:35,900
That's why you get some of these, like,
Amazon website

60
00:03:36,133 --> 00:03:39,700
that if you were searching
on another website for,

61
00:03:40,033 --> 00:03:42,700
gloves or a snow

62
00:03:42,700 --> 00:03:48,100
shovel all of a sudden on Amazon,
it knows about gloves and snow shovels

63
00:03:48,100 --> 00:03:49,666
because there's a cookie

64
00:03:49,666 --> 00:03:53,500
that's set there with some common language
that it can, that it can use.

65
00:03:53,500 --> 00:03:53,933
Right.

66
00:03:53,933 --> 00:03:56,933
So that's kind of the
the sorts of things that are there.

67
00:03:57,100 --> 00:03:59,766
It's great for storing preferences.

68
00:03:59,766 --> 00:04:03,666
When I go to a website,
maybe I always want it to be dark scheme

69
00:04:04,000 --> 00:04:06,600
or themed and of light themed.

70
00:04:06,600 --> 00:04:09,133
It can remember those sorts of things
that can be passed in

71
00:04:09,133 --> 00:04:12,333
in these cookie session,
or these cookies that are being passed in.

72
00:04:12,900 --> 00:04:13,733
All right.

73
00:04:13,733 --> 00:04:18,033
Another common thing that's passed in
is something called a session identifier,

74
00:04:19,166 --> 00:04:21,866
which we're going to talk about sessions
here in a little bit.

75
00:04:21,866 --> 00:04:24,066
Now here's some cookie attributes.

76
00:04:24,066 --> 00:04:27,433
Remember it's a key value pair basically.

77
00:04:27,700 --> 00:04:31,166
And so here are some attributes
that you can set in your cookies

78
00:04:31,433 --> 00:04:34,466
secure
which says only send the cookie over.

79
00:04:35,600 --> 00:04:36,933
Please only do that.

80
00:04:36,933 --> 00:04:39,466
That's it helps prevent leakage.

81
00:04:39,466 --> 00:04:42,466
And it helps prevent against CSR.

82
00:04:42,966 --> 00:04:45,966
Csrf attacks.

83
00:04:47,033 --> 00:04:49,333
And then also Http only.

84
00:04:49,333 --> 00:04:52,333
This means that I can only access it,

85
00:04:52,400 --> 00:04:56,500
via http call now via JavaScript.

86
00:04:56,833 --> 00:04:58,233
And this is important right.

87
00:04:58,233 --> 00:05:00,333
So it's only going to happen
through the browser.

88
00:05:00,333 --> 00:05:03,800
And so through a JavaScript
acting on your behalf.

89
00:05:04,033 --> 00:05:07,533
This limits many, XSS attacks

90
00:05:07,766 --> 00:05:12,066
where a JavaScript tend take your identity
and start acting as you.

91
00:05:12,466 --> 00:05:16,166
That or take a session
and start acting as you,

92
00:05:16,166 --> 00:05:19,933
directly inside, 
your, your browser itself.

93
00:05:19,933 --> 00:05:22,033
So that prevents that from happening.

94
00:05:22,033 --> 00:05:24,933
Some other attributes, same site
which controls

95
00:05:24,933 --> 00:05:27,933
sending cookies across
cross-site requests.

96
00:05:27,933 --> 00:05:32,166
And that's a very important thing
to put in your Csrf, which says,

97
00:05:32,533 --> 00:05:37,700
this cookie can only be used on one site,
not being used on multiple sites.

98
00:05:38,200 --> 00:05:39,266
Domain and path.

99
00:05:39,266 --> 00:05:42,800
What host or host or URLs are received?

100
00:05:43,166 --> 00:05:44,633
Receive the cookie.

101
00:05:44,633 --> 00:05:47,633
So this could
this could lock things down even more.

102
00:05:47,633 --> 00:05:52,500
And in expiry age and and time on that
are some other core attributes of cookies.

103
00:05:55,266 --> 00:05:55,600
All right.

104
00:05:55,600 --> 00:05:57,766
So we talked about cookies
are some of the browsers site.

105
00:05:57,766 --> 00:06:02,466
I'm going to send information about who
I am my preferences whatever session ID

106
00:06:03,033 --> 00:06:06,666
oh session ID
sessions are on the server side.

107
00:06:06,966 --> 00:06:09,633
This is a data structure per user state.

108
00:06:09,633 --> 00:06:12,933
It contains the user identity
and authorization states.

109
00:06:12,933 --> 00:06:14,466
Sometimes roles and permissions.

110
00:06:14,466 --> 00:06:16,000
When we talked about tokens,

111
00:06:16,000 --> 00:06:19,000
it would store token on the server side
in that session.

112
00:06:19,566 --> 00:06:22,566
And other pre user states

113
00:06:22,566 --> 00:06:26,100
like a cart I can store our cart,
I can store,

114
00:06:26,333 --> 00:06:29,600
this is great
when you've got, multi-step transactions

115
00:06:29,600 --> 00:06:32,700
that are going on
on, on the server side, remember

116
00:06:33,500 --> 00:06:37,166
I don't store state in the Http
server itself

117
00:06:37,933 --> 00:06:41,233
when a new connection comes in, it's
like a brand new, oh, you're brand new.

118
00:06:41,433 --> 00:06:43,133
Let's start where you left off.

119
00:06:43,133 --> 00:06:44,600
I need to know where you left off.

120
00:06:44,600 --> 00:06:48,900
So this is where I'm going
to, store state for that session, right?

121
00:06:49,033 --> 00:06:53,000
You typically want to key and have
a unique identifier for each session.

122
00:06:53,666 --> 00:06:56,666
With a random session ID has to be random.

123
00:06:57,333 --> 00:07:00,300
I would seed your random because you don't
want someone guessing session IDs,

124
00:07:00,300 --> 00:07:03,633
because then someone can become you,
which you don't want, right?

125
00:07:04,100 --> 00:07:07,566
And it's usually stored the session ID
is usually stored in the cookie

126
00:07:07,833 --> 00:07:08,833
on the browser side.

127
00:07:08,833 --> 00:07:13,000
So when someone logs in, maybe a hotel

128
00:07:13,000 --> 00:07:17,000
reservation, log in to marriott.com,
a session ID is created.

129
00:07:17,500 --> 00:07:19,933
It's stored as a cookie.

130
00:07:19,933 --> 00:07:23,833
And then when I'm working through the I'm

131
00:07:23,833 --> 00:07:27,700
trying to find the exact right
hotel for my trip to the Bahamas.

132
00:07:27,700 --> 00:07:29,533
Wouldn't that be great?

133
00:07:29,533 --> 00:07:30,433
Then?

134
00:07:30,433 --> 00:07:32,600
I don't have to log in each time.

135
00:07:32,600 --> 00:07:35,766
I don't have to go back
and look at what I've already looked at.

136
00:07:36,166 --> 00:07:39,266
All that information
can be stored in session,

137
00:07:40,533 --> 00:07:43,533
just with the session ID, which is great.

138
00:07:44,566 --> 00:07:47,400
Okay,
so like I already said before, the server

139
00:07:47,400 --> 00:07:51,233
creates a new session with a session ID,
it passes it back.

140
00:07:51,233 --> 00:07:54,866
It's stored in on the cookie
with a set cookie

141
00:07:54,866 --> 00:07:58,000
from the browser
or from the server up to the browser.

142
00:07:58,266 --> 00:07:58,800
Right.

143
00:07:58,800 --> 00:08:02,833
The server can then look up that session
ID every time a new request comes in,

144
00:08:02,833 --> 00:08:06,800
and I know where my state is and
and what I've been doing on that server.

145
00:08:07,433 --> 00:08:08,500
All right.

146
00:08:08,500 --> 00:08:11,733
Now here's some trade offs on
where am I storing the state.

147
00:08:11,733 --> 00:08:14,700
It could be in memory, per node.

148
00:08:14,700 --> 00:08:17,800
Now, this means that a session cannot span
multiple nodes.

149
00:08:17,800 --> 00:08:24,000
So if, if I, have a short span
here, that works fine.

150
00:08:24,000 --> 00:08:27,433
But if I have a long span,
I may have that server.

151
00:08:27,433 --> 00:08:30,433
That web server may have been recycled.

152
00:08:30,866 --> 00:08:31,200
Right.

153
00:08:31,200 --> 00:08:35,400
Or maybe I've got, 
100 or 1000 web servers that are serving

154
00:08:35,400 --> 00:08:38,733
up, you know, a million users or whatever
the case may be.

155
00:08:39,233 --> 00:08:43,233
And if it switches between,
you know, calls,

156
00:08:43,233 --> 00:08:46,633
maybe the user stepped out for, 
five minutes or something.

157
00:08:46,866 --> 00:08:49,466
They come back now,
they're attached to a different server

158
00:08:49,466 --> 00:08:50,833
then in-memory doesn't work.

159
00:08:50,833 --> 00:08:53,266
So I need like a shared store, right?

160
00:08:53,266 --> 00:08:55,766
Like a cache or a database server.

161
00:08:55,766 --> 00:09:00,666
A central place for storing session state
that can work across multiple servers.

162
00:09:00,666 --> 00:09:01,566
That's important.

163
00:09:01,566 --> 00:09:03,600
And then there's another one
called stateless.

164
00:09:03,600 --> 00:09:08,800
With which could be JWT based,
where I'm actually storing the state more

165
00:09:08,800 --> 00:09:13,266
in the cookies and the tokens that are
that are being passed back and forth.

166
00:09:13,266 --> 00:09:18,033
So it's, it's almost like this circle
that goes around in that

167
00:09:18,666 --> 00:09:22,933
I create that JWT, on the server side,

168
00:09:22,933 --> 00:09:28,100
I pass it back into,
the cookies, that, cookie is stored

169
00:09:28,100 --> 00:09:32,833
and then passed in again,
from the browser if they keep working.

170
00:09:33,166 --> 00:09:38,400
And then I just update this JWT
as it cycles through and that's it.

171
00:09:38,466 --> 00:09:39,700
That's more complex.

172
00:09:39,700 --> 00:09:43,633
And you got to deal with tokens and
validation and all that sort of things,

173
00:09:43,866 --> 00:09:46,566
and you can't really store
too much stuff in a JWT.

174
00:09:46,566 --> 00:09:49,566
You can say I get, but you can store

175
00:09:49,566 --> 00:09:53,200
as much as you could like
in on the server side storage.

176
00:09:53,200 --> 00:09:55,400
So those are trade offs
that you need to look at.

177
00:09:57,300 --> 00:09:58,433
So simple.

178
00:09:58,433 --> 00:10:01,433
Flow diagram on this a user logs in,

179
00:10:01,866 --> 00:10:04,866
they do a post log in.

180
00:10:05,133 --> 00:10:09,033
It creates a session with a session
ID and a user state

181
00:10:09,866 --> 00:10:12,166
now is stored in the session store.

182
00:10:12,166 --> 00:10:16,266
I pass that session ID back
as set cookie into the browser.

183
00:10:16,500 --> 00:10:20,400
Now when the user clicks on anything else
like a profile,

184
00:10:20,633 --> 00:10:23,633
the session ID is passed in as a cookie.

185
00:10:23,766 --> 00:10:27,100
I look up the session ID,
I pass in the user state

186
00:10:27,100 --> 00:10:31,400
into the web server, and the profile page
comes back in this example.

187
00:10:31,566 --> 00:10:34,566
So pretty straightforward stuff.

188
00:10:35,133 --> 00:10:38,033
Okay, let's talk about some risks

189
00:10:38,033 --> 00:10:40,966
because now I've got state
that's stored in the server.

190
00:10:40,966 --> 00:10:45,333
And I've got a way to access
that state or to

191
00:10:46,333 --> 00:10:49,666
yeah a way to mimic
that state in the browser.

192
00:10:49,666 --> 00:10:51,933
Say hey, is your session ID, right.

193
00:10:51,933 --> 00:10:55,300
So this is where things
could get really interesting.

194
00:10:55,300 --> 00:10:58,733
So through an access,
I can steal cookies.

195
00:10:58,733 --> 00:11:01,566
So this is a script
that's running on your site.

196
00:11:01,566 --> 00:11:05,166
It's a cross script. Cross-site script.

197
00:11:05,233 --> 00:11:08,233
Can steal that session ID

198
00:11:08,466 --> 00:11:12,166
and then, it can then, act as you

199
00:11:12,166 --> 00:11:15,900
and in that script to be running
right there in your own thing.

200
00:11:16,566 --> 00:11:21,400
If if you're not using Https,
then it could be intercepted.

201
00:11:21,400 --> 00:11:24,100
Your session ID
could be intercepted as well,

202
00:11:24,100 --> 00:11:27,100
because you want that encrypted,
that session ID going across.

203
00:11:27,100 --> 00:11:27,600
Right.

204
00:11:27,600 --> 00:11:31,933
People can look at your logs and other
leaked, leaks that are in there.

205
00:11:31,933 --> 00:11:35,900
So if you're storing the session ID,
I would encrypt the session ID in logs

206
00:11:35,900 --> 00:11:37,466
and things like that. Right.

207
00:11:38,500 --> 00:11:40,566
With the session ID

208
00:11:40,566 --> 00:11:45,366
man, the attacker can impersonate the user
and and they can stay

209
00:11:45,366 --> 00:11:48,966
impersonating the user until that session
is expired or destroyed.

210
00:11:49,700 --> 00:11:54,000
Okay, so here are some, session
hijacking.

211
00:11:54,000 --> 00:11:56,066
The attacker obtains the session ID.

212
00:11:56,066 --> 00:11:58,800
I already talked about this
as a duplicate.

213
00:11:58,800 --> 00:12:01,166
There you go.
All right. No. How do we fix it?

214
00:12:01,166 --> 00:12:03,766
Here we go. How do we fix this?

215
00:12:03,766 --> 00:12:07,233
We use https
for all authenticated traffic.

216
00:12:07,500 --> 00:12:10,866
We marked session cookies
with secure in HTP only.

217
00:12:10,866 --> 00:12:13,133
That will prevent the XSS.

218
00:12:13,133 --> 00:12:15,666
XSS stealing cookies. Right.

219
00:12:15,666 --> 00:12:18,933
Because a script can no longer act as you,
it only has to go through a browser.

220
00:12:19,266 --> 00:12:24,333
You strong random session
IDs don't just increment your session IDs.

221
00:12:24,466 --> 00:12:27,700
Session one. Session two. Session three.

222
00:12:27,900 --> 00:12:31,100
Someone's going to guess what
the next session is going to be right?

223
00:12:31,533 --> 00:12:34,566
So you want to
randomly generate session IDs

224
00:12:34,733 --> 00:12:37,633
and then regenerate session IDs on log in.

225
00:12:37,633 --> 00:12:42,900
And any privileged change for example,
maybe I want a new session ID

226
00:12:43,066 --> 00:12:46,766
when I'm taking money out of my bank,
or when I'm paying for things

227
00:12:47,233 --> 00:12:50,466
different than when I'm just accessing,

228
00:12:50,466 --> 00:12:53,466
how much money I have in my bank account.

229
00:12:53,466 --> 00:12:55,400
That could be a
completely different session.

230
00:12:57,733 --> 00:12:58,566
Okay.

231
00:12:58,566 --> 00:13:01,033
Session fixation, mitigation risks.

232
00:13:01,033 --> 00:13:05,366
The attacker can set an influence,

233
00:13:05,433 --> 00:13:08,433
or influence a victim's session ID.

234
00:13:08,700 --> 00:13:11,800
The victim
can, logs in using that session.

235
00:13:12,033 --> 00:13:15,966
So this is where they're spoofing
the session ID of front.

236
00:13:16,700 --> 00:13:17,000
Right.

237
00:13:17,000 --> 00:13:20,600
And then the server buys the identity
to that session ID that it was given.

238
00:13:20,966 --> 00:13:23,966
And the attacker
can use that over and over again.

239
00:13:24,166 --> 00:13:27,166
So this is where I have given
a session ID.

240
00:13:27,566 --> 00:13:30,933
And on the back end I'm like oh
yeah I session it here.

241
00:13:31,400 --> 00:13:34,966
I'm going to use that session ID
you never want to do that.

242
00:13:34,966 --> 00:13:37,966
So how do we mitigate that.

243
00:13:38,166 --> 00:13:42,300
Well we have to regenerate
the session ID after login.

244
00:13:42,900 --> 00:13:45,966
Don't take a session ID at login. Right.

245
00:13:45,966 --> 00:13:48,600
And don't accept any session IDs.

246
00:13:48,600 --> 00:13:53,366
From external the session IDs are created
on the server, not the other way around.

247
00:13:53,866 --> 00:13:56,566
Don't do not expose your session

248
00:13:56,566 --> 00:14:00,233
IDs in query parameters
or public links or locks.

249
00:14:00,666 --> 00:14:02,533
All right.
This is the best way to fix this problem

250
00:14:04,300 --> 00:14:05,033
okay.

251
00:14:05,033 --> 00:14:06,966
All right let's talk about Csrf.

252
00:14:06,966 --> 00:14:09,633
So Csrf is really interesting right.

253
00:14:09,633 --> 00:14:13,366
This is when a browser
automatically automatically adds cookies

254
00:14:13,566 --> 00:14:15,000
to matching domains.

255
00:14:15,000 --> 00:14:18,966
Attacker can trick the user's browser
into sending a request

256
00:14:18,966 --> 00:14:22,133
as them to a site
where the user is logged in.

257
00:14:22,433 --> 00:14:25,900
These cross these cross-site

258
00:14:26,333 --> 00:14:30,466
attacks are have were much more common.

259
00:14:30,833 --> 00:14:33,700
Now there's some great,
things that you can do

260
00:14:33,700 --> 00:14:36,700
to prevent these, like when the server.

261
00:14:37,033 --> 00:14:38,400
Well, we'll talk about that.

262
00:14:38,400 --> 00:14:41,400
So what happens is
the server is going to receive a valid

263
00:14:42,066 --> 00:14:45,066
cookie, and session ID,

264
00:14:45,533 --> 00:14:48,833
and then the request can,
looks like it's coming from that user.

265
00:14:49,266 --> 00:14:52,800
So what happens here and is

266
00:14:52,800 --> 00:14:55,800
a user can log into like their bank

267
00:14:56,066 --> 00:14:59,066
in one tab on the same browser.

268
00:14:59,200 --> 00:15:03,866
And then a user visits evil
dot example on another tab.

269
00:15:04,266 --> 00:15:04,833
Right.

270
00:15:04,833 --> 00:15:10,033
The evil example sends a
post to the bank example with

271
00:15:11,500 --> 00:15:12,433
the session ID

272
00:15:12,433 --> 00:15:15,433
because it's in the same browser, right?

273
00:15:15,533 --> 00:15:19,533
So the attacker now can become that user
and can transfer money out.

274
00:15:20,766 --> 00:15:22,266
And the browser includes.

275
00:15:22,266 --> 00:15:25,266
So the browser, because the browser
has all those cookies, there.

276
00:15:25,733 --> 00:15:28,200
So this this can be a problem. Right.

277
00:15:28,200 --> 00:15:32,900
So the interesting thing about it is
the victim is authenticated.

278
00:15:33,933 --> 00:15:35,400
The cookies are they're the sessions.

279
00:15:35,400 --> 00:15:36,666
They're all valid.

280
00:15:36,666 --> 00:15:41,333
But now I've got a one browser
that is actually

281
00:15:41,633 --> 00:15:45,966
or one page
that is actually accessing those cookies,

282
00:15:46,533 --> 00:15:50,566
sending it a request back
through the browser, an Http request.

283
00:15:50,566 --> 00:15:52,333
So it's coming from the same browser.

284
00:15:52,333 --> 00:15:55,333
And then going off
and doing the transfer.

285
00:15:55,400 --> 00:15:55,933
Right.

286
00:15:55,933 --> 00:15:58,900
So this is very insidious.

287
00:15:58,900 --> 00:16:00,900
And could be very hard to detect.

288
00:16:00,900 --> 00:16:03,166
And very hard to, fight against.

289
00:16:03,166 --> 00:16:04,666
So we're going to show you
some techniques.

290
00:16:04,666 --> 00:16:06,466
So here's a diagram
that shows how it all works.

291
00:16:06,466 --> 00:16:09,633
So user logs into the bank
on the browser,

292
00:16:10,133 --> 00:16:13,100
it gets its authorization, it gets,

293
00:16:13,100 --> 00:16:16,100
cookies are coming back.

294
00:16:16,200 --> 00:16:19,200
And the session
ID, it's all authenticated.

295
00:16:19,566 --> 00:16:22,866
I do it, 
and the browser has all that information.

296
00:16:22,866 --> 00:16:24,833
Right. I'm good to go.

297
00:16:24,833 --> 00:16:27,766
Then the user in another tab
in their browser

298
00:16:27,766 --> 00:16:30,766
visits evil dot example.

299
00:16:31,100 --> 00:16:31,833
Right.

300
00:16:31,833 --> 00:16:33,266
Well evil dot example.

301
00:16:33,266 --> 00:16:36,066
On the server side it goes, hey,

302
00:16:37,100 --> 00:16:38,733
there's a hidden form in there

303
00:16:38,733 --> 00:16:42,800
that does a pose to bank
example transfer.

304
00:16:42,800 --> 00:16:46,200
So they visit the site,
it grabs that cookie information

305
00:16:46,600 --> 00:16:49,600
of back into the browser. Right.

306
00:16:49,600 --> 00:16:51,633
So it's sending back to the browser.

307
00:16:51,633 --> 00:16:53,033
Hey, I want you to do this.

308
00:16:53,033 --> 00:16:54,966
The cookie information is there.

309
00:16:54,966 --> 00:16:57,300
It fills out that form.

310
00:16:57,300 --> 00:16:59,933
It has the correct session ID,
it calls transfer

311
00:16:59,933 --> 00:17:02,966
on the session ID
and then the transfer is complete.

312
00:17:03,433 --> 00:17:06,433
And the attacker
just got all of your stuff

313
00:17:07,866 --> 00:17:08,866
right.

314
00:17:08,866 --> 00:17:10,866
Pretty insidious.

315
00:17:10,866 --> 00:17:12,666
So what can I do?

316
00:17:12,666 --> 00:17:15,666
How do I get,
how do I get around all of this?

317
00:17:15,900 --> 00:17:18,333
Well, let's take a look at that.

318
00:17:18,333 --> 00:17:19,500
Right.

319
00:17:19,500 --> 00:17:23,800
First off, the attacker is triggering
a cross-site request.

320
00:17:23,933 --> 00:17:27,633
That's what is called a cross-site request
right now.

321
00:17:27,633 --> 00:17:31,200
There are times when you when you would
really like a cross-site request

322
00:17:31,200 --> 00:17:35,366
in some of your architectures,
you may run into it, but you got it.

323
00:17:35,366 --> 00:17:37,000
You got to prevent these things
from happening

324
00:17:37,000 --> 00:17:40,566
because this can expose you
to a third party.

325
00:17:40,866 --> 00:17:43,400
Getting access to your

326
00:17:44,766 --> 00:17:46,833
information and passing in,

327
00:17:46,833 --> 00:17:51,233
passing in APIs
that you don't want to have happen.

328
00:17:51,233 --> 00:17:51,966
Right.

329
00:17:51,966 --> 00:17:56,233
So the attacker site, if you set it up
properly, the attacker site can't read

330
00:17:56,233 --> 00:18:00,300
the CSR have tokens,
so you've got to set them correctly.

331
00:18:01,333 --> 00:18:07,833
It can and it can't correctly guess
the secret token without a valid token.

332
00:18:07,833 --> 00:18:11,400
The server will then reject,
any dangerous requests that comes in.

333
00:18:12,433 --> 00:18:15,600
So in this case here,
I load a page in the browser,

334
00:18:15,966 --> 00:18:20,866
I'm getting my settings, I'm passing back
the form and the Csrf token.

335
00:18:21,066 --> 00:18:24,633
So if someone's passing a form,
I know what the Csrf token is.

336
00:18:24,966 --> 00:18:29,000
I can submit the form
I'm passing back in the Csrf token

337
00:18:29,433 --> 00:18:33,800
and the session ID, I validate both
and then I can pass on.

338
00:18:33,800 --> 00:18:39,200
So anytime I'm doing a post on my server
side, I should be using this, technique.

339
00:18:40,600 --> 00:18:41,866
Okay, here

340
00:18:41,866 --> 00:18:45,433
are some of the, 
things that you could set in your cookies.

341
00:18:45,733 --> 00:18:47,900
Same site attribute.

342
00:18:47,900 --> 00:18:50,600
So if you say same site lacks

343
00:18:50,600 --> 00:18:53,600
then you're sending top level
Nat navigations.

344
00:18:53,600 --> 00:18:54,400
This works great.

345
00:18:54,400 --> 00:18:57,100
I can block any cross-site posts

346
00:18:57,100 --> 00:19:00,100
and iframes,
so I don't allow any iframes in there.

347
00:19:00,333 --> 00:19:05,133
If I say strict, you always send
same site request period.

348
00:19:05,133 --> 00:19:13,466
No top level navigation
if I so strict strong Csrf protection and.

349
00:19:13,566 --> 00:19:18,866
But there is some UX impact which
I have seen, I can tell on certain sites

350
00:19:19,200 --> 00:19:23,533
when they've turned this on completely
because the user experience isn't as good.

351
00:19:24,033 --> 00:19:24,266
Right.

352
00:19:24,266 --> 00:19:26,033
And then another option is,

353
00:19:26,033 --> 00:19:30,400
when I do have some cross site like,
single sign on flows,

354
00:19:30,800 --> 00:19:34,200
I need to set that to none
and then say secure.

355
00:19:34,266 --> 00:19:38,533
But you must set secure because that will,
that will help with your encryption.

356
00:19:39,700 --> 00:19:40,133
Right.

357
00:19:40,133 --> 00:19:45,133
Some additional Csrf, defenses are
you want to re authenticate

358
00:19:45,433 --> 00:19:49,166
or set up auth for any critical actions
like transferring money,

359
00:19:49,566 --> 00:19:54,133
launching weapons,
you know, whatever the case may be

360
00:19:54,433 --> 00:20:00,133
on your microservice that you're doing,
use custom headers for APIs and Csrf

361
00:20:00,133 --> 00:20:04,833
tokens that the people would know, 
a little bit of obscurity there

362
00:20:05,066 --> 00:20:08,300
and then make high risk operations,
multi-step where possible.

363
00:20:08,633 --> 00:20:09,266
Right.

364
00:20:09,266 --> 00:20:14,066
And then monitor for usual and unusual
patterns and around sensitive actions.

365
00:20:14,733 --> 00:20:16,833
Monitoring is is key here.

366
00:20:16,833 --> 00:20:18,033
All right.

367
00:20:18,033 --> 00:20:20,566
So putting this all together

368
00:20:20,566 --> 00:20:23,800
cookies are stored where in the browser.

369
00:20:23,833 --> 00:20:24,200
Right.

370
00:20:24,200 --> 00:20:29,633
They're very convenient primary but
they're also the primary surface for csvs.

371
00:20:29,700 --> 00:20:31,166
So you got to be careful.

372
00:20:31,166 --> 00:20:34,166
Local session
storage is not automatically set.

373
00:20:34,400 --> 00:20:39,666
Common history
is to store those in a cache.

374
00:20:39,666 --> 00:20:42,300
And most browsers
allow you to do that now.

375
00:20:42,300 --> 00:20:43,066
Right.

376
00:20:43,066 --> 00:20:48,066
Typical secure pattern is session cookies
for logging in on state.

377
00:20:48,400 --> 00:20:53,166
Make sure you set 
secure is GTP only and use same site.

378
00:20:54,200 --> 00:20:57,300
And then, make sure that on the back end

379
00:20:57,566 --> 00:21:02,166
that I can take a Csrf
tokens in forms and headers.

380
00:21:02,166 --> 00:21:04,866
I can pass those back in.

381
00:21:04,866 --> 00:21:09,366
So the browser, is, verified
one more time

382
00:21:09,633 --> 00:21:11,666
that, hey,
this is actually coming from the browser

383
00:21:11,666 --> 00:21:14,666
and not from a third party
going through the browser.

384
00:21:16,533 --> 00:21:17,733
Okay,

385
00:21:17,733 --> 00:21:21,466
that's cookies sessions and how to protect

386
00:21:21,466 --> 00:21:25,033
against these different, 
hacking techniques that are out there.

387
00:21:25,466 --> 00:21:28,366
Make sure that you look at the trade offs

388
00:21:28,366 --> 00:21:31,433
on these, you're adding more complexity
and overhead to things,

389
00:21:31,700 --> 00:21:35,700
but you are creating,
more secure applications.
